# 云同步（iCloud/Dropbox 等）

将 RSS 数据同步到多设备（如 Mac + 未来的 iOS 应用）：

1. 编辑 `~/.config/kenseader/config.toml`
2. 设置 `data_dir` 为云存储路径：

   ```toml
   [general]
   # iCloud (macOS)
   data_dir = "~/Library/Mobile Documents/com~apple~CloudDocs/kenseader"

   # 或 Dropbox
   # data_dir = "~/Dropbox/kenseader"
   ```

3. 重启守护进程：`kenseader daemon stop && kenseader daemon start`

## 功能特性

- **波浪线展开**：路径支持 `~` 表示用户主目录（如 `~/Dropbox/kenseader`）
- **自动迁移**：修改 `data_dir` 时，现有数据会自动迁移到新位置
- **冲突检测**：如果新路径已存在数据库文件，守护进程会报错而非覆盖

## 同步内容

| 项目 | 是否同步 | 备注 |
|------|----------|------|
| 数据库 (`kenseader.db`) | 是 | 包含订阅源、文章、阅读状态、摘要等 |
| 图片缓存 (`image_cache/`) | 是 | 缓存的文章图片 |
| Socket 文件 (`kenseader.sock`) | 否 | 仅用于本地 IPC |
| PID 文件 (`daemon.pid`) | 否 | 本地进程跟踪 |

## 多设备同步的只读模式

使用云同步时，可以在**只读模式**下运行 TUI 来浏览文章，无需运行守护进程。适用场景：
- 在一台设备（如台式机）上运行守护进程，在另一台设备（如笔记本）上阅读
- 快速只读访问，无需启动守护进程
- 使用云同步时，另一台设备负责更新订阅源

```bash
# 以只读模式启动 TUI（无需守护进程）
kenseader run --read-mode
```

**只读模式功能：**
- 直接从同步的数据库浏览文章
- 可切换已读/未读状态（数据库锁定时自动重试写入）
- 可收藏/书签文章
- 状态栏和窗口标题显示 `[READ]` 指示器

**只读模式限制：**
- 无法刷新订阅源（由守护进程处理）
- 无法添加/删除订阅
- 数据库写入可能偶尔失败（如另一台设备正在写入时），会自动重试

**典型工作流：**
1. 在主设备上运行守护进程：`kenseader daemon start`
2. 在其他设备上使用只读模式：`kenseader run --read-mode`
3. 云同步保持所有设备的数据库同步

## 技术细节

Kenseader 使用多项 SQLite 优化来实现可靠的多设备云同步：

### WAL 模式（预写日志）

数据库使用 WAL 日志模式而非默认的 DELETE 模式，这提供了：
- **并发读写**：多台设备可以同时读取，同时有一台设备写入
- **更好的性能**：读操作不会阻塞写操作，反之亦然
- **崩溃恢复**：未完成的事务会自动回滚

### 重试机制

写操作（标记已读、切换书签等）包含自动重试逻辑：
- 遇到数据库繁忙/锁定错误时，操作最多重试 5 次
- 使用指数退避策略（200ms、400ms、800ms、1600ms、3200ms）
- 大多数并发访问冲突在 1-2 次重试内解决

### 锁文件处理

启动时，应用程序会检查可能由其他设备创建且未正确同步的陈旧锁文件（`.db-wal`、`.db-shm`）。超过 30 秒未修改的文件会被自动清理。

### PRAGMA 配置

以下 SQLite 设置针对云同步场景进行了优化：
- `busy_timeout = 10000` - 等待锁定最长 10 秒（高并发场景下增加等待时间）
- `journal_mode = WAL` - 启用 WAL 模式
- `synchronous = NORMAL` - 安全性和性能的平衡
- `wal_autocheckpoint = 2000` - 定期 WAL 检查点（约 8MB）

### 连接池与并发控制

为处理高并发场景（守护进程 + TUI + 云同步）：
- **连接池**：15 个连接（原为 5 个）以处理并行操作
- **IPC 并发限制**：最多同时处理 10 个并发请求，防止连接池耗尽
- **批量操作**：标签采用批量插入以减少数据库往返次数

## 注意事项

- 配置文件（`~/.config/kenseader/config.toml`）不会被同步，保持本地独立
- 未来 iOS 开发：SQLite 数据库可以直接被 iOS 应用读取（使用 GRDB.swift 或 SQLite.swift 等库）
